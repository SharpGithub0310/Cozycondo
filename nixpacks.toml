[phases.setup]
nixPkgs = ["nodejs_20", "npm-10_x", "bash"]

[phases.install]
cmds = ["npm install --omit=dev --no-audit --no-fund"]

[phases.build]
cmds = [
  "chmod +x start.sh",
  "npm run build",
  "echo 'Optimizing standalone build for faster startup...'",
  "ls -la .next/",
  "if [ -d '.next/static' ]; then mkdir -p .next/standalone/.next && cp -r .next/static .next/standalone/.next/ && echo 'Static files copied to standalone'; else echo 'No static files found'; fi",
  "if [ -d 'public' ]; then cp -r public .next/standalone/ && echo 'Public files copied to standalone'; else echo 'No public files found'; fi",
  "echo 'Build optimization completed - verifying structure:'",
  "ls -la .next/standalone/",
  "ls -la .next/standalone/.next/ || echo 'No .next directory in standalone'",
  "ls -la .next/standalone/public/ || echo 'No public directory in standalone'"
]

[start]
cmd = "./start.sh"

[variables]
NEXT_TELEMETRY_DISABLED = "1"
NODE_ENV = "production"
HOSTNAME = "0.0.0.0"
PORT = "3000"
# Memory and performance optimizations
NODE_OPTIONS = "--max-old-space-size=512 --enable-source-maps=false"
SILENT_MODE = "true"
# Next.js optimizations
NEXT_OPTIMIZE_FONTS = "false"
NEXT_OPTIMIZE_IMAGES = "false"

# Health check configuration for Dokploy - ultra-fast endpoint
[healthcheck]
path = "/api/health/fast"
port = "$PORT"
interval = "15s"
timeout = "10s"
retries = 3
start_period = "60s"
